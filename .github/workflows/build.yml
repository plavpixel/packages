name: Build packages
on:
  workflow_dispatch:
  push:
    branches: [master]
    paths: [srcpkgs/**]

permissions:
  contents: write
  packages: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/void-linux/void-glibc-full:latest
      options: --privileged
      env:
        XBPS_ARCH: x86_64
        XBPS_ALLOW_CHROOT_BREAKOUT: yes
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        arch: [x86_64, x86_64-musl]
    steps:
      - name: Prepare Container
        run: |
          xbps-install -Syu xbps
          xbps-install -y git bash gnupg tar curl

          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE/void-packages"

      - name: Clone Repository
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Shallow Clone Void-Packages
        run: |
          git submodule update --init --recursive --depth 1

      - name: Identify changed templates
        id: changes
        run: |
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ] || [ -z "${{ github.event.before }}" ]; then
             CHANGED=$(git diff --name-only HEAD~1..HEAD | grep "^srcpkgs/" | cut -d/ -f2 | sort -u | xargs)
          else
             CHANGED=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep "^srcpkgs/" | cut -d/ -f2 | sort -u | xargs)
          fi

          if [ -z "$CHANGED" ]; then
            echo "No changes detected."
            echo "templates=" >> $GITHUB_OUTPUT
          else
            echo "Detected changes in: $CHANGED"
            echo "templates=$CHANGED" >> $GITHUB_OUTPUT
          fi

      - name: Bootstrap xbps-src
        run: ./build.sh bootstrap

      - name: Build Packages
        if: steps.changes.outputs.templates != ''
        env:
          XBPS_TARGET_ARCH: ${{ matrix.arch }}
        run: |
          for pkg in ${{ steps.changes.outputs.templates }}; do
            echo "Building $pkg for ${{ matrix.arch }}..."
            ./build.sh build "$pkg"
          done

      - name: Sign Packages
        if: steps.changes.outputs.templates != ''
        env:
          GPG_PASS: ${{ secrets.PRIVATE_PEM_GPG_PASS }}
        run: |
          gpg --quiet --batch --yes --pinentry-mode loopback --decrypt --passphrase="$GPG_PASS" --output private.pem private.pem.gpg

          xbps-rindex --privkey private.pem --sign-pkg --signedby "Haris <plavpxl@proton.me>" hostdir/binpkgs/*.xbps

      - name: Deploy to Website
        if: steps.changes.outputs.templates != ''
        run: |
          git config --global user.name "Voiders Builder Bot"
          git config --global user.email "bot@voiders.community"

          git clone https://github.com/voiders-community/voiders-community.github.io.git website
          mkdir -p website/packages

          cp -f hostdir/binpkgs/*.xbps website/packages/
          cp -f hostdir/binpkgs/*.sig* website/packages/ 2>/dev/null || true

          cd website/packages

          xbps-rindex --force -a *.xbps
          xbps-rindex --privkey ../../private.pem --sign --signedby "Haris <plavpxl@proton.me>" .

          cd ..

          git add packages/
          git commit -m "[ci] Update ${{ matrix.arch }} packages in /packages: ${{ steps.changes.outputs.templates }}"
          git pull --rebase origin main
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/voiders-community/voiders-community.github.io.git
          git push origin main
